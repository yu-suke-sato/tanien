<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三角関数マスター：レイアウト最適化版</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f7f9;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
        }
        h1 { font-size: 1.4rem; margin-bottom: 15px; }

        /* Toolbar Styles */
        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
        }
        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tool-group span { font-weight: bold; font-size: 1rem; }
        
        select {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            background: #fff;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #2980b9; }
        button.clear-btn { background-color: #95a5a6; }
        button.clear-btn:hover { background-color: #7f8c8d; }
        
        .radio-group { display: flex; gap: 10px; font-size: 0.9rem; margin-right: 15px;}
        
        /* Canvas Area */
        .canvas-wrapper {
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        canvas { display: block; border-radius: 12px; cursor: crosshair; }

        /* Info Panel */
        .info-panel {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            max-width: 600px;
            justify-content: center;
        }
        .val-box {
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 80px;
            flex: 1;
        }
        .val-label { font-size: 0.75rem; color: #7f8c8d; margin-bottom: 4px; }
        .val-data { font-size: 1.1rem; font-weight: bold; display: flex; justify-content: center; align-items: center;}
        
        .text-red { color: #e74c3c; }
        .text-blue { color: #2980b9; }
        .text-purple { color: #8e44ad; }
        .text-orange { color: #e67e22; }

        /* HTML Fraction helper */
        .frac { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; font-size: 0.85em; margin: 0 2px; }
        .frac-top { border-bottom: 1px solid currentColor; padding: 0 2px; }
        .frac-bot { padding: 0 2px; }

    </style>
</head>
<body>

    <h1>三角関数マスター：定義と方程式</h1>

    <div class="toolbar">
        <div class="radio-group">
            <label><input type="radio" name="mode" value="degree" checked> 度数法</label>
            <label><input type="radio" name="mode" value="radian"> 弧度法</label>
        </div>

        <div class="tool-group">
            <span style="color:#2980b9;">sinθ = </span>
            <select id="select-sin">
                <option value="" disabled selected>値を選択</option>
                <option value="1">1</option>
                <option value="0.8660254">√3 / 2</option>
                <option value="0.7071067">√2 / 2</option>
                <option value="0.5">1 / 2</option>
                <option value="0">0</option>
                <option value="-0.5">- 1 / 2</option>
                <option value="-0.7071067">- √2 / 2</option>
                <option value="-0.8660254">- √3 / 2</option>
                <option value="-1">-1</option>
            </select>
            <button onclick="setSinLine()">表示</button>
        </div>
        <div class="tool-group">
            <span style="color:#e74c3c;">cosθ = </span>
            <select id="select-cos">
                <option value="" disabled selected>値を選択</option>
                <option value="1">1</option>
                <option value="0.8660254">√3 / 2</option>
                <option value="0.7071067">√2 / 2</option>
                <option value="0.5">1 / 2</option>
                <option value="0">0</option>
                <option value="-0.5">- 1 / 2</option>
                <option value="-0.7071067">- √2 / 2</option>
                <option value="-0.8660254">- √3 / 2</option>
                <option value="-1">-1</option>
            </select>
            <button onclick="setCosLine()">表示</button>
        </div>
        <button class="clear-btn" onclick="clearLines()">クリア</button>
    </div>

    <div class="canvas-wrapper">
        <canvas id="mainCanvas" width="600" height="500"></canvas>
    </div>

    <div class="info-panel">
        <div class="val-box" style="border-bottom: 3px solid #8e44ad;">
            <div class="val-label">偏角 θ</div>
            <div class="val-data text-purple" id="disp-angle">0°</div>
        </div>
        <div class="val-box" style="border-bottom: 3px solid #e67e22;">
            <div class="val-label">直角三角形の内角 α</div>
            <div class="val-data text-orange" id="disp-ref-angle">0°</div>
        </div>
        <div class="val-box" style="border-bottom: 3px solid #e74c3c;">
            <div class="val-label">cos θ (底辺)</div>
            <div class="val-data text-red" id="disp-cos">1</div>
        </div>
        <div class="val-box" style="border-bottom: 3px solid #2980b9;">
            <div class="val-label">sin θ (高さ)</div>
            <div class="val-data text-blue" id="disp-sin">0</div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    
    // Geometry Config
    const width = canvas.width;
    const height = canvas.height;
    const cx = width / 2; 
    const cy = height / 2; 
    const r = 180; 
    
    // State
    let angleRad = Math.PI / 6; // Initial 30 deg
    let isDragging = false;
    let mode = 'degree';
    let targetSin = null; 
    let targetCos = null; 

    // DOM Elements
    const dispAngle = document.getElementById('disp-angle');
    const dispRefAngle = document.getElementById('disp-ref-angle');
    const dispCos = document.getElementById('disp-cos');
    const dispSin = document.getElementById('disp-sin');
    const radios = document.getElementsByName('mode');

    // Value Maps for Pretty Printing
    const exactValues = [
        { val: 0, str: "0", tex: "0" },
        { val: 0.5, str: "1/2", tex: `<div class="frac"><span class="frac-top">1</span><span class="frac-bot">2</span></div>` },
        { val: -0.5, str: "-1/2", tex: `<div class="frac"><span class="frac-top">-1</span><span class="frac-bot">2</span></div>` },
        { val: Math.sqrt(2)/2, str: "√2/2", tex: `<div class="frac"><span class="frac-top">√2</span><span class="frac-bot">2</span></div>` },
        { val: -Math.sqrt(2)/2, str: "-√2/2", tex: `<div class="frac"><span class="frac-top">-√2</span><span class="frac-bot">2</span></div>` },
        { val: Math.sqrt(3)/2, str: "√3/2", tex: `<div class="frac"><span class="frac-top">√3</span><span class="frac-bot">2</span></div>` },
        { val: -Math.sqrt(3)/2, str: "-√3/2", tex: `<div class="frac"><span class="frac-top">-√3</span><span class="frac-bot">2</span></div>` },
        { val: 1, str: "1", tex: "1" },
        { val: -1, str: "-1", tex: "-1" }
    ];

    function getDisplayValue(num) {
        for (let item of exactValues) {
            if (Math.abs(num - item.val) < 1e-6) {
                return item;
            }
        }
        let f = num.toFixed(2);
        return { val: num, str: f, tex: f };
    }

    function toDegree(rad) {
        let d = rad * 180 / Math.PI;
        if (d < 0) d += 360;
        return d % 360;
    }

    const snapAngles = [0, 30, 45, 60, 90, 120, 135, 150, 180, 210, 225, 240, 270, 300, 315, 330, 360];

    function getSnappedState(rad) {
        let deg = toDegree(rad);
        let snapped = false;
        let displayDeg = deg;
        
        for (let s of snapAngles) {
            if (Math.abs(deg - s) < 3) { 
                displayDeg = s;
                snapped = true;
                break;
            }
        }
        
        const finalRad = snapped ? displayDeg * Math.PI / 180 : rad;
        
        let c = Math.cos(finalRad);
        let s = Math.sin(finalRad);

        if (snapped) {
            if (Math.abs(c) < 1e-10) c = 0;
            if (Math.abs(s) < 1e-10) s = 0;
        }

        let ref = Math.acos(Math.abs(c)) * 180 / Math.PI;
        if (Math.abs(Math.round(ref) - ref) < 0.1) ref = Math.round(ref);

        return {
            rad: finalRad,
            deg: displayDeg,
            cos: c,
            sin: s,
            refDeg: ref,
            isSnapped: snapped,
            cosObj: getDisplayValue(c),
            sinObj: getDisplayValue(s)
        };
    }

    function drawText(text, x, y, color, align='center', baseline='middle', fontSize=14) {
        ctx.save();
        ctx.font = `bold ${fontSize}px Arial, sans-serif`;
        ctx.textAlign = align;
        ctx.textBaseline = baseline;
        ctx.lineWidth = 3;
        ctx.strokeStyle = 'rgba(255,255,255,0.9)';
        ctx.strokeText(text, x, y);
        ctx.fillStyle = color;
        ctx.fillText(text, x, y);
        ctx.restore();
    }

    function update() {
        ctx.clearRect(0, 0, width, height);
        drawGrid();
        drawEquationLines();

        // Unit Circle
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, 2*Math.PI);
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.stroke();

        const state = getSnappedState(angleRad);
        const px = cx + r * state.cos;
        const py = cy - r * state.sin; 

        // Triangle
        // Base
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(px, cy);
        ctx.strokeStyle = '#e74c3c'; ctx.lineWidth = 4; ctx.stroke();
        // Height
        ctx.beginPath(); ctx.moveTo(px, cy); ctx.lineTo(px, py);
        ctx.strokeStyle = '#2980b9'; ctx.lineWidth = 4; ctx.stroke();
        // Hypotenuse
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(px, py);
        ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 2; ctx.stroke();

        // Angles
        drawAngleArc(state);
        drawRefAngleArc(state);

        // Point P
        ctx.beginPath();
        ctx.arc(px, py, 8, 0, 2*Math.PI);
        ctx.fillStyle = '#2c3e50';
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('P', px, py);

        // Draw Labels on Canvas
        drawDynamicLabels(state, px, py);

        // Panel
        updatePanel(state);
    }

    function drawGrid() {
        ctx.save();
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(width, cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, height); ctx.stroke();
        ctx.fillStyle = '#7f8c8d';
        ctx.font = '12px Arial';
        ctx.fillText('x', width - 15, cy + 20);
        ctx.fillText('y', cx + 10, 15);
        ctx.restore();
    }

    function drawEquationLines() {
        ctx.save();
        ctx.setLineDash([5, 5]);
        ctx.lineWidth = 2;

        if (targetSin !== null) {
            const lineY = cy - targetSin * r;
            const valObj = getDisplayValue(targetSin);
            ctx.beginPath(); ctx.moveTo(0, lineY); ctx.lineTo(width, lineY);
            ctx.strokeStyle = '#2980b9'; ctx.stroke();
            drawText(`y = ${valObj.str}`, 30, lineY - 10, '#2980b9', 'left');
            
            if (Math.abs(targetSin) <= 1) {
                const xVal = Math.sqrt(1 - targetSin*targetSin);
                [xVal, -xVal].forEach(xv => {
                    ctx.beginPath(); ctx.arc(cx + xv*r, lineY, 5, 0, 2*Math.PI);
                    ctx.fillStyle = '#e67e22'; ctx.fill();
                });
            }
        }

        if (targetCos !== null) {
            const lineX = cx + targetCos * r;
            const valObj = getDisplayValue(targetCos);
            ctx.beginPath(); ctx.moveTo(lineX, 0); ctx.lineTo(lineX, height);
            ctx.strokeStyle = '#e74c3c'; ctx.stroke();
            drawText(`x = ${valObj.str}`, lineX + 5, 20, '#e74c3c', 'left');

             if (Math.abs(targetCos) <= 1) {
                const yVal = Math.sqrt(1 - targetCos*targetCos);
                [yVal, -yVal].forEach(yv => {
                    ctx.beginPath(); ctx.arc(lineX, cy - yv*r, 5, 0, 2*Math.PI);
                    ctx.fillStyle = '#e67e22'; ctx.fill();
                });
            }
        }
        ctx.restore();
    }

    function drawAngleArc(state) {
        const arcR = 45;
        const endAng = -state.rad;
        ctx.beginPath();
        ctx.arc(cx, cy, arcR, 0, endAng, true); 
        ctx.strokeStyle = '#8e44ad';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Label (Theta)
        const labelAng = state.rad / 2;
        const lx = cx + (arcR + 20) * Math.cos(labelAng);
        const ly = cy - (arcR + 20) * Math.sin(labelAng);
        
        let txt = mode === 'degree' ? `${Math.round(state.deg)}°` : (state.rad).toFixed(2);
        if (mode === 'radian' && state.isSnapped) {
             const map = {0:'0', 30:'π/6', 45:'π/4', 60:'π/3', 90:'π/2', 120:'2π/3', 135:'3π/4', 150:'5π/6', 180:'π', 210:'7π/6', 225:'5π/4', 240:'4π/3', 270:'3π/2', 300:'5π/3', 315:'7π/4', 330:'11π/6', 360:'2π'};
             if (map[state.deg]) txt = map[state.deg];
        }
        drawText(txt, lx, ly, '#8e44ad');
    }

    function drawRefAngleArc(state) {
        // 1. Hide if on axis
        if (state.deg % 90 === 0) return; 
        
        // 2. Hide if Angle == Ref Angle (1st Quadrant)
        // Using a small epsilon or integer comparison
        if (state.deg > 0 && state.deg < 90) return;

        const arcR = 30;
        const th = -state.rad;
        
        ctx.beginPath();
        ctx.strokeStyle = '#e67e22';
        ctx.lineWidth = 2;
        ctx.setLineDash([3, 2]);

        // Logic to draw arc attached to X-axis
        if (state.deg < 90) { 
            ctx.arc(cx, cy, arcR, 0, th, true); 
        }
        else if (state.deg < 180) { 
            ctx.arc(cx, cy, arcR, Math.PI, th, false); 
        }
        else if (state.deg < 270) { 
            ctx.arc(cx, cy, arcR, Math.PI, th, true); 
        }
        else { 
            ctx.arc(cx, cy, arcR, 0, th, false); 
        }
        ctx.stroke();
        ctx.setLineDash([]);

        // Draw Reference Angle Value on Canvas
        let refRad = state.refDeg * Math.PI / 180;
        let displayAngle = 0;
        if (state.deg <= 90) displayAngle = refRad / 2;
        else if (state.deg <= 180) displayAngle = Math.PI - refRad/2;
        else if (state.deg <= 270) displayAngle = Math.PI + refRad/2;
        else displayAngle = 2*Math.PI - refRad/2;

        const lx = cx + (arcR + 15) * Math.cos(displayAngle);
        const ly = cy - (arcR + 15) * Math.sin(displayAngle);

        let txt = mode === 'degree' ? `${Math.round(state.refDeg)}°` : (state.refDeg * Math.PI/180).toFixed(2);
        if (mode === 'radian' && state.isSnapped) {
             const map = {30:'π/6', 45:'π/4', 60:'π/3'};
             if (map[Math.round(state.refDeg)]) txt = map[Math.round(state.refDeg)];
        }

        drawText(txt, lx, ly, '#e67e22', 'center', 'middle', 11);
    }

    function drawDynamicLabels(state, px, py) {
        // --- COS (Base) Label ---
        // Logic: Always display "Outside" the triangle.
        // Triangle is formed between X-axis and the hypotenuse.
        // Q1/Q2 (sin > 0): Triangle is ABOVE axis. Outside is BELOW axis.
        // Q3/Q4 (sin < 0): Triangle is BELOW axis. Outside is ABOVE axis.
        
        const midX = (cx + px) / 2;
        let cosY, cosBaseLine;
        
        if (state.sin >= 0) {
            // Upper Half -> Text Below Axis
            cosY = cy + 25; 
            cosBaseLine = 'top';
            // Label "cos" slightly above value
            drawText("cos", midX, cosY - 14, '#c0392b', 'center', 'middle', 12);
            drawText(state.cosObj.str, midX, cosY, '#c0392b', 'center', 'middle', 13);
        } else {
            // Lower Half -> Text Above Axis
            cosY = cy - 25;
            cosBaseLine = 'bottom';
            // Label "cos" slightly below value (or layout: Value then 'cos' below it? 
            // Let's keep order: Cos text, then Value)
            // Actually layout: [Value] above [cos] above [Axis]
            drawText("cos", midX, cosY + 14, '#c0392b', 'center', 'middle', 12);
            drawText(state.cosObj.str, midX, cosY, '#c0392b', 'center', 'middle', 13);
        }

        // --- SIN (Height) Label ---
        // Logic: Put text to Right or Left of the vertical line (x=cos)
        // Q1/Q4 (cos > 0): Line is to Right. Put text to Right (Outside).
        // Q2/Q3 (cos < 0): Line is to Left. Put text to Left (Outside).
        
        const midY = (cy + py) / 2;
        let sinX; 
        let align = 'left';
        
        if (state.cos >= 0) {
            // Right side
            sinX = px + 10;
            align = 'left';
        } else {
            // Left side
            sinX = px - 10;
            align = 'right';
        }

        drawText("sin", sinX, midY - 15, '#2980b9', align, 'middle', 12);
        drawText(state.sinObj.str, sinX, midY, '#2980b9', align, 'middle', 13);

        // Right angle mark
        if (Math.abs(state.cos) > 0.05 && Math.abs(state.sin) > 0.05) {
            const size = 10;
            const sx = Math.sign(state.cos);
            const sy = Math.sign(state.sin);
            ctx.beginPath();
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 1;
            ctx.moveTo(px - size*sx, cy);
            ctx.lineTo(px - size*sx, cy - size*sy);
            ctx.lineTo(px, cy - size*sy);
            ctx.stroke();
        }
    }

    function updatePanel(state) {
        let angTxt = mode === 'degree' ? Math.round(state.deg) + '°' : state.rad.toFixed(2);
        if (mode === 'radian' && state.isSnapped) {
             const map = {0:'0', 30:'π/6', 45:'π/4', 60:'π/3', 90:'π/2', 120:'2π/3', 135:'3π/4', 150:'5π/6', 180:'π', 210:'7π/6', 225:'5π/4', 240:'4π/3', 270:'3π/2', 300:'5π/3', 315:'7π/4', 330:'11π/6', 360:'2π'};
             if (map[state.deg]) angTxt = map[state.deg];
        }
        dispAngle.textContent = angTxt;

        // Reference Angle
        let refTxt = mode === 'degree' ? Math.round(state.refDeg) + '°' : (state.refDeg * Math.PI / 180).toFixed(2);
        if (mode === 'radian' && state.isSnapped) {
            const rDeg = Math.round(state.refDeg);
            const map = {0:'0', 30:'π/6', 45:'π/4', 60:'π/3', 90:'π/2'};
            if (map[rDeg]) refTxt = map[rDeg];
        }
        dispRefAngle.textContent = refTxt;

        dispCos.innerHTML = state.cosObj.tex;
        dispSin.innerHTML = state.sinObj.tex;
    }

    // --- Interaction ---
    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;
        return { x: (clientX - rect.left)*scaleX, y: (clientY - rect.top)*scaleY };
    }

    function handleInput(x, y) {
        const dx = x - cx;
        const dy = cy - y; 
        let ang = Math.atan2(dy, dx);
        if (ang < 0) ang += 2*Math.PI;
        angleRad = ang;
        update();
    }

    canvas.addEventListener('mousedown', e => { isDragging = true; handleInput(getMousePos(e).x, getMousePos(e).y); });
    window.addEventListener('mousemove', e => { if(isDragging) handleInput(getMousePos(e).x, getMousePos(e).y); });
    window.addEventListener('mouseup', () => isDragging = false);
    
    canvas.addEventListener('touchstart', e => { isDragging = true; handleInput(getMousePos(e).x, getMousePos(e).y); e.preventDefault(); }, {passive:false});
    window.addEventListener('touchmove', e => { if(isDragging) handleInput(getMousePos(e).x, getMousePos(e).y); e.preventDefault(); }, {passive:false});
    window.addEventListener('touchend', () => isDragging = false);

    radios.forEach(r => r.addEventListener('change', e => { mode = e.target.value; update(); }));

    window.setSinLine = function() {
        const sel = document.getElementById('select-sin');
        const val = parseFloat(sel.value);
        if (!isNaN(val)) { targetSin = val; update(); }
    };
    window.setCosLine = function() {
        const sel = document.getElementById('select-cos');
        const val = parseFloat(sel.value);
        if (!isNaN(val)) { targetCos = val; update(); }
    };
    window.clearLines = function() {
        targetSin = null;
        targetCos = null;
        document.getElementById('select-sin').selectedIndex = 0;
        document.getElementById('select-cos').selectedIndex = 0;
        update();
    };

    update();

</script>
</body>
</html>